<%- include('../layouts/header') %>

    <div class="max-w-4xl mx-auto bg-white p-8 border border-gray-200 rounded-lg shadow-md">
        <div class="flex justify-between items-start border-b pb-4 mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">
                    <%= project.title %>
                </h1>
                <p class="text-sm text-gray-600">
                    Created: <span class="font-medium">
                        <%= project.creator.username %>
                    </span>
                    | <%= project.createdAt.toLocaleDateString('en-US') %>
                </p>
            </div>

            <% if (user && (user.id===project.userId || user.role==='admin' )) { %>
                <div class="flex space-x-3">
                    <a href="/projects/<%= project.id %>/edit"
                        class="bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-medium py-2 px-4 rounded-md transition duration-150">
                        Edit
                    </a>

                    <form action="/projects/<%= project.id %>?_method=DELETE" method="POST"
                        onsubmit="return confirm('Are you sure you want to delete this project?');">
                        <button type="submit"
                            class="bg-red-500 hover:bg-red-600 text-white text-sm font-medium py-2 px-4 rounded-md transition duration-150">
                            Delete
                        </button>
                    </form>
                </div>
                <% } %>
        </div>

        <h2 class="text-xl font-semibold text-gray-800 mb-3">Description</h2>
        <div class="text-gray-700 leading-relaxed border p-4 bg-gray-50 rounded-lg mb-8">
            <% if (project.description) { %>
                <p>
                    <%= project.description %>
                </p>
                <% } else { %>
                    <p class="italic text-gray-500">No description has been entered for this project</p>
                    <% } %>
        </div>

        <h2 class="text-xl font-semibold text-gray-800 mt-10 mb-3">Threads</h2>

        <% if (user && (user.id===project.userId || user.role==='admin' )) { %>
            <form action="/threads" method="POST" class="mb-6 flex gap-3">
                <input type="hidden" name="projectId" value="<%= project.id %>">
                <input type="text" name="title" placeholder="New thread title" required
                    class="border p-2 rounded w-full">
                <button class="bg-green-600 text-white px-4 rounded">
                    Create
                </button>
            </form>
            <% } %>


                <% if (project.Threads && project.Threads.length> 0) { %>
                    <% project.Threads.forEach(thread=> { %>

                        <div class="border rounded p-4 mb-6 bg-gray-50">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-semibold text-lg">
                                    <%= thread.title %>
                                </h3>

                                <% if (user && (user.id===project.userId || user.role==='admin' )) { %>
                                    <div class="flex gap-2">
                                        <a href="/threads/<%= thread.id %>/edit" class="text-blue-600 text-sm">Edit</a>
                                        <form action="/threads/<%= thread.id %>?_method=DELETE" method="POST">
                                            <button class="text-red-500 text-sm">Delete</button>
                                        </form>
                                    </div>
                                    <% } %>
                            </div>

                            <% if (thread.Messages && thread.Messages.length> 0) { %>
                                <ul class="mb-3 space-y-2">
                                    <% thread.Messages.forEach(msg=> { %>
                                        <li class="bg-white p-2 rounded border">
                                            <p class="text-sm">
                                                <%= msg.content %>
                                            </p>

                                            <% if (user && (user.id===msg.userId || user.role==='admin' )) { %>
                                                <div class="text-right text-xs">
                                                    <a href="/messages/<%= msg.id %>/edit"
                                                        class="text-blue-600">Edit</a>
                                                    |
                                                    <form action="/messages/<%= msg.id %>?_method=DELETE" method="POST"
                                                        class="inline">
                                                        <button class="text-red-500">Delete</button>
                                                    </form>
                                                </div>
                                                <% } %>
                                        </li>
                                        <% }) %>
                                </ul>
                                <% } else { %>
                                    <p class="text-sm italic text-gray-500 mb-2">No messages yet</p>
                                    <% } %>

                                        <% if (user) { %>
                                            <form action="/messages" method="POST" class="mt-2">
                                                <input type="hidden" name="threadId" value="<%= thread.id %>">
                                                <textarea name="content" required class="border p-2 w-full mb-2"
                                                    placeholder="Write a message..."></textarea>
                                                <button class="bg-blue-600 text-white px-3 py-1 rounded">
                                                    Send
                                                </button>
                                            </form>
                                            <% } %>
                        </div>

                        <% }) %>
                            <% } else { %>
                                <p class="italic text-gray-500">No threads yet</p>
                                <% } %>


                                    <h2 class="text-xl font-semibold text-gray-800 mb-3">Attachments</h2>

                                    <% if (user) { %>
                                        <form action="/attachments" method="POST" enctype="multipart/form-data"
                                            class="mb-6 flex items-center gap-3">
                                            <input type="hidden" name="projectId" value="<%= project.id %>">

                                            <input type="file" name="file" required class="block w-full text-sm text-gray-700
                          file:mr-4 file:py-2 file:px-4
                          file:rounded-md file:border-0
                          file:text-sm file:font-semibold
                          file:bg-blue-50 file:text-blue-700
                          hover:file:bg-blue-100" />

                                            <button type="submit"
                                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm">
                                                Upload
                                            </button>
                                        </form>
                                        <% } %>

                                            <% if (project.Attachments && project.Attachments.length> 0) { %>
                                                <ul class="space-y-3">
                                                    <% project.Attachments.forEach(file=> { %>
                                                        <li
                                                            class="flex justify-between items-center bg-gray-50 p-3 rounded-md border">
                                                            <a href="/uploads/<%= file.filepath %>" target="_blank"
                                                                class="text-blue-600 hover:underline text-sm font-medium">
                                                                <%= file.filename %>
                                                            </a>

                                                            <% if (user && (user.id===file.userId || user.role==='admin'
                                                                )) { %>
                                                                <form
                                                                    action="/attachments/<%= file.id %>?_method=DELETE"
                                                                    method="POST">
                                                                    <button type="submit"
                                                                        class="text-red-500 hover:text-red-700 text-sm">
                                                                        Delete
                                                                    </button>
                                                                </form>
                                                                <% } %>
                                                        </li>
                                                        <% }) %>
                                                </ul>
                                                <% } else { %>
                                                    <p class="italic text-gray-500">No attachments yet</p>
                                                    <% } %>
    </div>

    <%- include('../layouts/footer') %>